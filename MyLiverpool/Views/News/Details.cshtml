@using MyLiverpoolSite.Business.ViewModels.NewsComments
@model MyLiverpoolSite.Business.ViewModels.News.IndexNewsViewModel
{
    ViewBag.Title = "Details";
}

<h2>Details</h2>

<div>
    <h4>IndexNewsViewModel</h4>
    <hr />
    <dl class="dl-horizontal">
        <dt>
            @Html.DisplayNameFor(model => model.Id)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.Id)
        </dd>

        <dt>
            @Html.DisplayNameFor(model => model.NewsCategory)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.NewsCategory.Name)
        </dd>

        <dt>
            @Html.DisplayNameFor(model => model.CanCommentary)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.CanCommentary)
        </dd>

        <dt>
            @Html.DisplayNameFor(model => model.AdditionTime)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.AdditionTime)
        </dd>

        <dt>
            @Html.DisplayNameFor(model => model.Title)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.Title)
        </dd>

        <dt>
            @Html.DisplayNameFor(model => model.Brief)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.Brief)
        </dd>

        <dt>
            @Html.DisplayNameFor(model => model.Message)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.Message)
        </dd>

        <dt>
            @Html.DisplayNameFor(model => model.Reads)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.Reads)
        </dd>

        <dt>
            @Html.DisplayNameFor(model => model.Source)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.Source)
        </dd>

        <dt>
            @Html.DisplayNameFor(model => model.PhotoPath)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.PhotoPath)
        </dd>

        <dt>
            @Html.DisplayNameFor(model => model.LastModified)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.LastModified)
        </dd>
    </dl>
    <section id="comments">
        @ShowTree(Model.Comments)
    </section>

    @if (User.Identity.IsAuthenticated)
    {
        <div>
            <textarea id="newsCommentMessage"></textarea>
            <br />
            <button id="addComment"> ADD</button>
        </div>
    }
</div>
@helper ShowTree(IEnumerable<IndexNewsCommentVM> comments)
        {
foreach (var comment in comments)
{
        <div class="comment">
            @Html.HiddenFor(c => comment.Id)
            @Html.DisplayFor(c => comment.Message)
            @Html.DisplayFor(c => comment.Author.UserName)
            <br />
            @if (User.Identity.IsAuthenticated)
            {
                <button class="reply">add reply </button>
            }
        </div>
    if (comment.Children.Any())
    {
            @ShowTree(comment.Children);
    }

}
}

<div id="add-reply" class="modal" tabindex="-1" style="display: none; width: 350px; margin: auto; margin-top: 300px; z-index: 999">
    <div class="modal-header">
        <h3 class="text-info">add reply</h3>
        <input id="parent-comment-id" value="" />
    </div>
    <div class="modal-body">
        <form class="form-horizontal" id="edit-aim-comment-form">
            <div class="control-group">
                <label style="padding-left: 35px;">comment</label>
                <div class="controls">
                    <textarea id="add-reply-comment" data-val="true" data-val-regex="" data-val-regex-pattern="^[^<>]+$"
                              data-val-required="enterComment" rows="5"
                              style="margin-left: -35px; margin-top: -21px; width: 519px;"></textarea>
                </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <button id="add-reply-comment-submit" class="btn btn-primary" type="submit" aria-hidden="true" style="margin-right: 20px;">Add</button>
        <a href="#" class="cancel" data-dismiss="modal" style="padding-right: 50px;">Cancel</a>
    </div>
</div>

<p>
    @Html.ActionLink("Edit", "Edit", new { id = Model.Id }) |
    @Html.ActionLink("Back to List", "Index")
</p>
@Scripts.Render("~/bundles/jquery")
<script>
    $('#addComment').click(function ()
    {
        console.log('add comment');
        postValues();
    });
    function postValues() {
        var comment = $('#newsCommentMessage').val();
        var newsId = @Model.Id;
        $.ajax({
            type: 'post',
            url: '@Url.Action("AddComment", "NewsComment")',
            data: { comment: comment, newsId: newsId },
            beforeSend: function() {

                //     $('#quality-achievement-modal').modal('hide');
            },
            success: function(response) {
                $('#newsCommentMessage').val('');
                publishComment(response, comment);
            }
        });
    }
    function publishComment(id, comment) {
        console.log(id);
        $('#comments').append("<div class='comment'> <input id='comment_Id' name='comment.Id' type='hidden' value=" + id + "> " + comment + "@User.Identity.Name <br> <button class='reply'>add reply </button></div>");
    }

    $('.reply').click(function() {
        console.log('reply');
        var comment = $(this).parent();
        console.log(comment);
        var id = comment.find(':first-child');
        $('#parent-comment-id').val(id.val());
        console.log(id.val());
        showReplyWindow();
    });

    function showReplyWindow() {
        $('#add-reply').show();
    }

    $('.cancel').click(function() {
        $('#add-reply').hide();
    });

    $('#add-reply-comment-submit').click(function() {
        console.log('add-reply-comment-submit click');
        var comment = $('#add-reply-comment').val();
        var newsId = @Model.Id;
        var parentId = $('#parent-comment-id').val();
        console.log('add-reply-comment-submit click 2');
        $.ajax({
            type: 'post',
            url: '@Url.Action("AddComment", "NewsComment")',
            data: { comment: comment, newsId: newsId, parentId: parentId },
            beforeSend: function() {

                //     $('#quality-achievement-modal').modal('hide');
            },
            success: function(response) {
                $('#add-reply-comment').val('');
                $('#add-reply').hide();
                publishComment(response, comment);
            }
        });
    });


</script>
